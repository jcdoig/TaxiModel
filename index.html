<!DOCTYPE html>
<html>

<head>
  <title>Learning</title>
  
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8">

  <script src="./files/d3.v3.min.js"></script>
  
  <style type="text/css">
  @import url(./files/style.css);
  @import url(//fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700);
  </style>

</head>

<body>

<svg xmlns:svg="http://www.w3.org/2000/svg" id="display" width="550" height="550">
  <g id="svg">
    <foreignObject xmlns="http://www.w3.org/2000/svg" height="500" width="500" y="25" x="25">
      <canvas id="canvas" xmlns="http://www.w3.org/1999/xhtml" width="500" height="500">
      
      </canvas>
    </foreignObject>
  </g>
</svg>
<script type='text/javascript'>
  var width,
    height,
    Family = {}


  personState = {
    NOT_ASSIGNED : 0,
    ASSIGNED : 1,
    IN_SERVICE : 2,
    SERVED : 3
  }

  taxiState = {
    IDLE : 0,
    ASSIGNED : 1,
    IN_SERVICE_AVAILABLE : 2,
    IN_SERVICE_ASSIGNED : 3
  }

  Taxis = []
  function Taxi(){
    Taxis.push(this)
    this.id = Taxis.indexOf(this)
    this.ox = Math.floor((Math.random()*width)+1)
    this.oy = Math.floor((Math.random()*height)+1)
    this.dx = this.ox
    this.dy = this.oy
    this.state = taxiState.IDLE // all taxis are initialized as idle, possible values are idle, assigned, inServiceAvailable, and inServiceUnavailable
    this.dropoffTime = 0
    this.passengerNow = null
    this.passengerNext = null
    this.distanceLeft = 0
  }

  numPax = 0;
  ActivePassengers = []
  ServedPassengers = []
  function Passenger(time){
    ActivePassengers.push(this)
    numPax++
    this.id = numPax
    this.ox = Math.floor((Math.random()*width)+1)
    this.oy = Math.floor((Math.random()*height)+1)
    this.taxi = null
    this.timeCreated = time
    this.waiting = 0;
    this.dx = Math.floor((Math.random()*width)+1)
    this.dy = Math.floor((Math.random()*height)+1)
    this.drop_off = function(){ // To be called after dropping the pax
      var array = ActivePassengers
      var index = array.indexOf(this)
      if (index > -1) {
       array.splice(index, 1)
       ServedPassengers.push(this)
      }
    }
  }

  // model parameters
  width = 500
  height = 500
  var speed = 50 // in pixels per millisecond, or something else, I need to think
  var lambda = 5 // in passengers per millisecond per area. I need to convert it to a random process
  var fleet = 50 // number of taxis


  function distance(passenger, taxi){
    //TODO: Change to a torus configuration
    return Math.sqrt( (passenger.ox - taxi.dx)*(passenger.ox - taxi.dx) + (passenger.oy - taxi.dy)*(passenger.oy - taxi.dy) )
  }

  function paintServiceArea(Taxi){
    //TODO: UI stuff
  }


  var fEvents = [] // future events
  var pEvents = [] // past events
  var stopTime = 10000

  function createTaxis(){
    for (var i = 0; i < 5; i++) {
      var taxi = new Taxi()
    };
  }

  function Event(agent, time, run, description){
    this.Agent = agent
    this.Time = time
    this.Run = run
    this.Description = description
    return this
  }

  function eventPassenger(time){ // creates an event to be excecuted at time "time"
    var delta = Math.log(1-(Math.random())/(-lambda/(width*height))
    var pass = new Passenger()
    function run(){
      assignTaxi(pass, time) // assigns this passenger
      eventPassenger(time+delta) // creates the next passenger event
    }
    var event = new Event(pass, time, run, "New customer")
    fEvents.push(event)
  }

  function assignTaxi(passenger, time){
    var availableTaxis = Taxis.filter(function(taxi){ return (taxi.state === taxiState.IDLE) || (taxi.state === taxiState.IN_SERVICE_AVAILABLE)})
    if (availableTaxis.length >= 1){
      availableTaxis.sort(function(a,b){
        var AtimeLeft = Math.max(a.dropoffTime - time, 0)
        var BtimeLeft = Math.max(b.dropoffTime - time, 0)
        return distance(passenger, a)/speed + AtimeLeft - distance(passenger, b)/speed - BtimeLeft
      })
      var taxi
      taxi = availableTaxis[0]
      if (taxi.state === taxiState.IN_SERVICE_AVAILABLE) {
        taxi.state = taxiState.IN_SERVICE_ASSIGNED
        console.log("Taxi " + taxi.id + " will drop off passenger " + taxi.passenger.id + " then it will pickup passenger " + passenger.id )
        taxi.passengerNext = passenger 
      } else { // this means the taxi is idle
        taxi.state = taxiState.ASSIGNED
        console.log("Taxi " + taxi.id + " on route to pickup passenger " + passenger.id  )
        taxi.passengerNext = passenger
        passenger.taxi = taxi
        eventPickUp(taxi, passenger)
        taxi.dx = passenger.ox
        taxi.dy = passenger.oy
      }
    } else {
      // El pasajero se va a la cola
    }
  }

  function eventPickUp(taxi, passenger){
    // move the passenger to the traveling state
    // remove the taxi from the current state and move it to the one where it belongs now
    // set an event to be excecuted when the taxi drops off the passenger
  }

  function eventDropOff(taxi, passenger){
    // remove the taxi from the current state and move it to the one where it belongs now
    // move the passenger to the happy customer state
  }
  
  console.log(new Date())
  eventPassenger(0)
  createTaxis()
  d3.timer(function(){
    fEvents.sort(function(a,b){return a.time-b.time})
    var event = fEvents.shift()
    event.Run()
    pEvents.push(event)

    var should_stop
    try {
      should_stop = (fEvents[0].Time > stopTime)
    } catch(err) {
      should_stop = false
    }
    if (should_stop) {console.log(new Date())}
    return should_stop
  })
</script>
</body>

</html>